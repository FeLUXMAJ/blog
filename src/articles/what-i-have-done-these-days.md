```metadata
{
  "title": "What I have done these days",
  "date": "2016-04-26 22:30:39",
  "tags":["Diary"]
}
```



## Buging in day,Coding at night

白天写bug,晚上写代码.
开玩笑,这段日子忙了了好几个地方.
思绪都没挺得下来.



### Hadoop Training & Sharing

#### Training Background
之前是公司安排了一个为期两天的Hadoop Training.
请了中科院的一个老师给参加培训的同事讲讲概念性的东西.
大概课程的内容就是`Hadoop`+`Hadoop平台体系`+`Hadoop衍生工具`.

讲完之后依然不知其所以然.
但是对大数据的实际应用场景已经有了比较深刻的印象:
- **选型决策**(其实主要理解还是这边)
- **传统行业改造**
- **促进信息消费**

#### Episode
有句讲句,大数据的数据挖掘方向让我感到神秘而有一丝厌恶.  
有时候在想,是不是搞大数据的人都这么喜欢装逼,卖弄.  
源自于我的大学班主任吕威.除了是我班主任,另一个身份是中大数据挖掘方向的研究生导师.  

他在本科的教学上看不出有任何的为师之道.(至少对我们这种学校).  
曾教我们的离散数学+数据结构与算法.  
一周两节课80分钟,套路都是固定的  
- 前10分钟,讲大数据很火,他读书的时候就是这个专业的,他很牛逼.  
- 10-20分钟,讲数据挖掘很牛逼,他和他的学生跟中移动合作项目,水平相当高.  
- 后10分钟,讲他的同学很牛逼,已经年入百万级别,但是让他跟他一起打拼,他又说自己处于安逸.  
- 剩下的讲PPT.不讲算法实质,演示全靠PPT(不过PPT做的不错,跟AMD有的一拼)  
- 听到大数据这么火,不禁想深入了解一下,每当学生问出这个问题的时候,他的回答总是走向('你只用知道我很牛逼+数据挖掘很牛逼,过程你就不必知道了,说了也不懂.')

至于为什么要指名道姓的点草他,也无所谓了.  
是大学生涯中少有的能全线让我评E的老师.  

吐槽完毕.  

#### Sharing
在接收培训完之后,回到Team里面必然需要分享一些学到的知识.  
不仅如此还需要给ITA的同事两周内介绍+一些实战分享.  
我的任务是分享HBase.  
对于没有在项目中经过实战经验的我来说,这个难度不低.  
在搭建环境中又看到了大数据平台的这些东西在部署,配置方面的一些套路,最后总结出一些有干货非假大空的分享,  
倒是花费了挺多经历.  


### Project Platform Migration

#### Background
从去年年底开始项目转移过来之后,就开始全职接手该项目的开发任务.  
由于这个是公司开始的比较早的实验性MEAN项目,项目代码/结构虽有很多可取之处,但是槽点更多.  

在用户数量逐渐增多,对可用性和稳定性的要求日渐增高的时候,项目的定位自然要从实验性项目升级到常规项目中.  
于是展开了HA(High Availability,高可用性)计划.  

#### Solution

HA计划分成下面几步来执行:  

**硬件方面**
- 数据库MongoDB部分迁移到MongoDB集群上.
- 项目部署方式迁移到Docker上,实现扩展性高的水平扩容.
- Redis单节点升级成Redis多节点.

**业务代码方面**
- 前端UI的性能优化
- 统一项目之间的日志规则

#### Challenge and Difficult

如果原先的代码架构标准,框架良好,单节点 <-> 多节点 之间的切换实际上并不需要深层的代码级别改动.  
但是之前说过代码的槽点比较多,而且没有一个正确的编码习惯.导致我们在增加节点的时候,遭遇了很多挑战.  
(这其有一部分感觉也是JavaScript的锅,这点大喷子王垠其实有喷过,某些方面还是要"苟同")

暂列出几点,感觉这些挑战和中间曲折的解决方案,即使抽去业务逻辑,也可以通过多几个篇幅来详细描述.  
嗯.这里就不一一细诉了:

- 数据访问层(Node.js)由单节点转变成多节点,UI展示层的Server端也转变成了多节点,加上新的生产环境中加多了一些防火墙,导致请求转发次数较多,不能顺利追踪.  
- 由于新的生产环境的代理和规律规则问题,前端的WebSocket无法维持与服务端的长连接(网上常见方案是修改Nginx配置,但是我们生产环境的代理是购买的第三方网络分配服务)
- 由于硬件的变化,Redis,socket.io,redis-socket.io 等JS库原先都在比较旧的版本.阅读过版本更变记录之后决定升级到新的库版本,但是出现了严重的连接错误.  
- 静态的数据文件迁移到专门的文件服务器,需要大量的DataPatch与合理的迁移方案  

- 由于一些历史的业务逻辑需求原因,需要在前端加载出所有数据.但是接手之前的代码并没有做一些常规的优化方案(分页,优化页面DOM节点数,减少Listener).开始着手优化,期望与硬件上的迁移升级同步带来更好的用户体验.

其中有一些坑在迁移测试的时候没有跌出来,导致第一次更换生产环境之后,系统不稳定,发生了几次故障,事态紧急性升高,时间都花在着手解决稳定性问题(网络配置,代码缺陷)上.

整个团队在紧张加班加点定位问题之后,发现问题根源不止一个,只能一个一个去制定解决方案.  

最后一个一个定位了已出现的问题,目前系统得以恢复稳定.HA的硬件部分暂告一段落,前端UI性能优化是我主要负责的部分,由于页面比较多,还需要提供一个合理的网页性能测试基准来比较优化前后的对比
这部分也是花了相当多的时间去阅读一些Angular性能优化最佳实践,做各种尝试.等等.

目前从已进行性能优化的两个页面来说,性能提升目测相当明显.  
主要的优化手段一个是将错误的Angular写法转变到正确的标准写法上,(其实就是先擦干净屁股).  
经过上面这种手段,前端的UI性能提升已经非常明显.至少限制了页面DOM和Listener的上限,不因数据量而线性增长压力.  
第二个才是在遵循规范的写法上更改UI操作的内部逻辑,寻求更高细粒度的优化.  


### Site SourceCode Refactor

#### Background
加班加多了自然在下班时间尽量不惦记一些技术问题.  
恰逢前端看到了Angular2 Beta版本的发布,便有想法通过重写主站代码,边学习Angular2,边学习Angular2官方推荐的TypeScript.
在着手做了几个Demo之后,发现两个问题,导致我对Angular2目前的版本暂时失去兴趣,还开始拒绝使用TypeScript.
1. Beta版本的Angular2开发体验特差.
在Angular1版本中,在html中手动加入`ng-app`的标记,即可当成是Angular Bootstrap,自启动的一个入口.

目前在Angular2中,加载了Angular2本身代码是远远不够的,因为他的bootstrap需要另外一个引路人的角色来帮忙启动.
即需要`Angular2`编写业务代码+引入`ES6,RxJS,SystemJS`,最终通过`System.import`+`Angular2`的入口文件才得以启动整个应用.  
所以说开发体验很差.


2. TypeScript 所吹嘘的语言特性都是鸡肋.
第二个情况就是虽然可以通过原生JS的方式编写Angular2代码,但是由于开发Angular2本身就是通过TypeScript写的.  
那么从最好的情况便是遵循官方推荐学习TypeScript.  
从官方吹的特性来看,TypeScript的出现主要是为了解决JavaScript的几类问题:  
我就不忍了直接边说边喷我的观点吧  
1. 弱类型->强类型.  
TypeScript是强类型的语言,虽然转译之后会变成弱类型的原生JavaScript代码,但是TypeScript本身就需要依赖IDE的提示进行静态类型检查,以提示错误.  
这就相当不必要了,有了Jetbrains系列产品,遵循ESLint/JSHint提示与蝴蝶书的规范,IDE本身就会简单的对JS代码进行浅层次的类型推导(更常见的方式是通过
JavaScript的注释文档中,限定参数的类型).  
都依赖IDE,为了调试代码的时候,还得可以通过`source map`再定位一次出问题的TypeScript代码.  
这不是自己找事吗.

2. 依赖tsd文件自动提示方法
为了实现OO概念,TypeScript添加了interface的概念,其中这些interface,接口定义文件存储在`.tsd`文件当中.  
然后IDE会预先读取定义好的tsd文件,当编写一个实现了该接口的实现类(或者新建一个对象的时候)便会根据`.tsd`进行方法自动提示.  
然后TypeScript吹的另外一个特点就是:可以与原生JavaScript混合使用.  

这跟口音不正的二打六演员去出演TVB然后夹着不纯正的广东话一样,吃了苍蝇的恶心.
然后去找了一下常见的JavaScript库的tsd,因为这些tsd文件软狗官方怎么会帮大家做维护呢?  
`lodash`的tsd文件我愣是没找到.那些个人维护的名不见经传的小众lib就不必多说了.
在开始系统化的大型JS项目之前,需要对用到的第三方lib进行仔细的阅读,然后编写一份tsd文件,只是为了在用TypeScript的时候获得接口化编程的体验.  
看来他们都不知道有IDEA.

无可否认.TypeScript的初衷和他的作者实力都相当强.但是强并不代表做出来的东西不成为一坨屎,也不必要赶着去吃它.  

然后我就放弃了TypeScript,对Angular2的原生版本还是持观望状态.  

#### Using Angular-Material

刚又不小心吐槽多了几个地方.
言归正传,重写主站代码的原因是一方面是想试试使用`Material Design`.
另外一方面是子站写日志的时候使用的是`Hexo`,一个类似Markdown的开源博客框架.  
在编写的时候通过Markdown的格式撰写日志内容,唯一恶心的就是他的header.

要求如下:
```
title: Hadoop 2.7.2 单节点与集群安装部署
date: 2016-04-09 13:09:51
tags:
  - Hadoop
  - Linux
---
```


这么说的话,使用IDEA的预览在即时预览中显示出来的效果就太难看了.  
于是我决定在从写的时候使用自定义的Markdown渲染器,自己定义一个可读性和渲染出来不难看的header.  
然后借助`marked`生成html.  

为此还添加了一个小Feature:Online Markdown Editor  
[Markdown Editor](http://aquariuslt.com/#/features/md-editor)  
支持已经被我抛弃的`Hexo`,`TOC标记`,`非严格模式`.  

花了挺多时间去写的.  
具体内容感觉觉得再开一个篇幅去讲.  




## An other Graduation season
有时候晚上醒来,我还以为我是一名学生.
昨天站在台上大合照的是我.


若然现时士气高昂  
即管放肆任性  
当你感到无力软弱  
切记不怪宿命  
若然做人未算聪明  
更要卖力亡命  
还未要负责之际 切记尽兴  
谁亦会随年变老  
方懂得童年多好  
等不到来年变老  
才怀念 那种悠然脚步  
来吧趁毫无控诉  
快释穿沿途的污糟  
这段少年时间 既然昂贵  
大好青春要尽耗  
记住要共最美的人分享每个夜晚  
别忘掉原是靠坚持医好每个伤患  
既是有力挺起胸膛即管好好作反  
无惧雨水沾湿两眼  
无用听谁来劝告  
一街的人言滔滔  
不需坐下来计数  
前行吧 你想做 全意做  
如没有无穷气数  
也可跟神明赌一铺  
这段少年时间 有谁无悔  
大好青春要消耗  
记住要共最美的人分享每个夜晚  
别忘掉原是靠坚持医好每个伤患  
记住趁尚有些本钱签多一些帐单  
如若你还淘气 你还强壮  
尽管出走别折返  
无需定立时限 如风一般往返  
人未老 还未晚  
还未到尽头记住来放心荒旦  
若生命是无限 何必自定界限  
大好青春就要多贪  
记住要共最美的人分享每个夜晚  
别忘掉原是靠坚持医好每个伤患  
记住趁尚有些本钱签多一些帐单  
如若你还淘气 你还强壮  
尽管出走别折返    
记住每日尽兴欢腾通宵至到达旦    
别忘掉原是以单纯体恤每个灾难    
既是有力挺起胸膛即管好好作反    
无惧雨水沾湿两眼 年月灿烂    

